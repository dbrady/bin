#!/usr/bin/env ruby
# frozen_string_literal: true

# diespringdie - Hunt down undead spring processes and drive stakes through their heart
# BONUS: Also kill stray/hung db migrations
require 'colorize'
require 'optimist'
require_relative 'lib/dbrady_cli'
String.disable_colorization unless $stdout.tty?

# CLI Application
class Application
  include DbradyCli

  opt_flag :db, :force, :restart

  def log(msg)
    puts msg unless quiet?
  end

  # rubocop:disable Metrics/AbcSize
  # rubocop:disable Metrics/MethodLength
  def parse_options
    @opts = Optimist.options do
      opt :debug, 'Print extra debug info', default: false
      opt :pretend, 'Print commands but do not run them', default: false
      opt :verbose, 'Run with verbose output (overrides --quiet)', default: false
      opt :force, 'After asking spring politely to shut down, get real intense if necessary', default: false
      opt :quiet, 'Run with minimal output', default: false
      opt :db, 'Kill db:migrate processes as well', default: false
      opt :restart, 'Pre-warm a fresh spring server after killing', default: true
    end
    opts[:quiet] = !opts[:verbose] if opts[:verbose_given]
    log opts.inspect if opts[:debug]
  end
  # rubocop:enable Metrics/MethodLength
  # rubocop:enable Metrics/AbcSize

  # I get it, I'm a bad programmer. Shaddap.
  def run
    parse_options
    run!
  end

  # rubocop:disable Metrics/AbcSize
  # rubocop:disable Metrics/CyclomaticComplexity
  # rubocop:disable Metrics/MethodLength
  # rubocop:disable Metrics/PerceivedComplexity
  def run!
    log 'Checking for running spring processes...'
    log "spring_is_running? #{spring_is_running?.inspect}"

    pid_lines = spring_pids
    pid_lines.each.with_index(1) { |line, index| log "#{index}: #{line}" } unless quiet?

    if db? # && db_migrate_is_running?
      log 'Killing db:migrate processes'
      db_migrate_pids.each do |pid|
        log pid
        run_command "kill #{pid}"
      end
    end

    if spring_pids.empty?
      log 'No spring pids found.'
    else
      log "Asking spring to stop via 'spring stop'..."
      command = 'spring stop'
      command += ' > /dev/null' if quiet?
      run_command command
      sleep 2

      pid_lines = spring_pids
      if pid_lines.any?
        log 'Asking remaining spring processes to go quietly into that good night...'
        pid_lines.each.with_index(1) { |line, index| log "#{index}: #{line}" } unless quiet?
        pids = pid_lines.map { |pid_line| pid_line.split[1] }
        pids.each do |pid|
          run_command "kill #{pid}"
        end
      end

      if force?
        sleep 5
        pid_lines = spring_pids

        if pid_lines.any?
          log 'Telling spring to go, kicking and screaming if necessary...'
          pid_lines.each.with_index(1) { |line, index| log "#{index}: #{line}" } unless quiet?
          pids = pid_lines.map { |pid_line| pid_line.split[1] }
          pids.each do |pid|
            run_command "kill -9 #{pid}"
          end
        end
      end

      sleep 2
    end

    log 'Cleaning up stale spring PID files and sockets...'
    run_command 'rm -rf tmp/spring/'

    log 'All done.'
    log "spring_is_running? #{spring_is_running?.inspect}"

    spring_pids.each.with_index { |line, index| log "#{index}: #{line}" } if spring_is_running?

    return unless restart?

    log 'Pre-warming a fresh spring server...'
    run_command 'spring server > /dev/null 2>&1 &disown'
  end
  # rubocop:enable Metrics/PerceivedComplexity
  # rubocop:enable Metrics/MethodLength
  # rubocop:enable Metrics/CyclomaticComplexity
  # rubocop:enable Metrics/AbcSize

  def spring_is_running?
    run_command 'ps auwx | grep -v diespringdie | grep [s]pring 2>&1 > /dev/null'
  end

  def spring_pids
    get_command_output_lines('ps auwx | grep [s]pring').find_all { |line| line.split[10] == 'spring' }
  end

  def db_migrate_pids
    get_command_output_lines("ps auwx | grep db:[m]igrate | awk '{ print $2 }'")
  end

  def db_migrate_is_running?
    run_command 'ps auwx | grep -v db:[m]igrate | grep [s]pring 2>&1 > /dev/null'
  end
end

Application.new.run if __FILE__ == $PROGRAM_NAME
